---
# The main Portainer install is on the server that is also the 'homeserver' in the inventory.
# Additional servers are 'outpost' servers that get Portainer Agent installed and registered
# to the main Portainer instance.
# This file builds the required variable to set the endpoints
# Please not that the first endpoint is a local one. Adding it throught the API fails.

- name: "Set info for this server as an endpoint"
  ansible.builtin.set_fact:
    endpoints:
      - { name: "{{ inventory_hostname }}", url: "", publicurl: '{{ ansible_default_ipv4.address }}', id: "{{ portainer_known_endpoint_ids[0] }}" }

- name: Block to add outpost servers as endpoints
  when: groups['outpost'] is defined
  block:
    - name: Setup endpoints variable for outpost nodes
      ansible.builtin.set_fact:
        agent_endpoints: >
          {%- set ep_list = [] -%}
          {%- for host in groups['outpost'] -%}
          {%-   set _ = ep_list.append({'name': host,
                                        'url': 'tcp://' + hostvars[host]['ansible_default_ipv4']['address'] + ':9001',
                                        'publicurl': hostvars[host]['ansible_default_ipv4']['address'],
                                        'id': loop.index + portainer_known_endpoint_ids[0] }) -%}
          {%- endfor -%}
          {{ ep_list }}
      loop: "{{ groups['outpost'] }}"
      loop_control:
        loop_var: host
    - name: Add the agent_endpoints to the og_endpoints variable
      ansible.builtin.set_fact:
        endpoints: "{{ endpoints + agent_endpoints }}"

- name: "Tell the user the list of endpoints"
  ansible.builtin.debug:
    var: endpoints
